# 生产化评估与改进计划（微信内网页场景）

更新时间：2026-01-11

> 适用约束：**项目是网页（H5）**，大概率在**微信/企业微信内**使用；不依赖短信能力。

---

## 0. 合同线路信息（当前应作为“基线配置”）

- **线路站点（始发/终点 + 停经）**
  1. 两岸金融中心地铁站3入口（始发）
  2. 乐丰财富中心（停经）
  3. 海西金融广场（停经）
  4. 万科云玺（终点）

- **运营时间**：仅工作日运行
- **发车与高峰**：
  - 早高峰：07:45–09:45
  - 晚高峰：17:45–19:45
  - **4 小时/天循环穿梭**
- **班次**：
  - 早班：07:45 / 08:05 / 08:25 / 08:45 / 09:05 / 09:25 / 09:45
  - 晚班：17:45 / 18:05 / 18:25 / 18:45 / 19:05 / 19:25 / 19:45
  - 每日不少于 14 趟
- **车辆信息**：
  - 车牌：闽D01982D
  - 发动机号：KLG157G:70012
- **司机信息**：
  - 吕庆刚 13959282886
- **服务能力**：提供车辆实时定位服务

> 注：站点名称请以合同为准（展示/导出/管理端均一致）。

---

## 1. 现状概述（已部署但含 demo 数据）

从代码与页面结构看，当前具备：
- **乘客端**：显示乘车二维码（动态刷新）、查看实时线路进度与车辆状态（轮询）、站点列表。
- **司机端**：位置上报入口、核验（扫码/输入票据）入口、核验统计与简单历史展示。
- **管理端**：运营看板（统计/图表）、车组信息（车牌/发动机/司机）、AI 建议入口。

当前属于“可演示 MVP”，但距离“可运营生产系统”仍缺少：
- 明确的**身份体系/权限隔离**
- 管理侧的**可配置与可追溯**能力
- 弱网/异常场景的**兜底**
- 运营需要的**数据口径与报表一致性**
- 用户反馈闭环与运维监控

---

## 2. 三角色视角评估

### 2.1 管理端（调度/运营/管理员）

**完整性**（缺口）
- 缺少“线路/班次/站点/车辆/司机/规则”的后台配置闭环（目前更多是展示）。
- 缺少多管理员分工（调度/运营/客服/只读）与 RBAC。
- 缺少操作审计：谁在何时改了什么（尤其班次与规则）。

**实用性**（缺口）
- 生产调度需要：今日班次执行情况、异常（延误/停运/改线）、司机签到、临时公告发布、乘客反馈工单。

**可靠性**（风险）
- 统计数据若是 demo/模拟，生产无法做 KPI 与对账。
- 缺少数据导出与证据链（核验明细、异常明细）。

**建议优先级**
- P0：配置化 + 审计 + 核验明细导出
- P1：异常事件与公告
- P2：多租户/多线路扩展

---

### 2.2 用户端（员工/乘客）

**完整性**
- 乘车码与实时位置是核心，但缺少“是否工作日运行/当日班次/下一班时间/到站 ETA”的明确呈现。
- 缺少“服务说明与规则”（有效期、核验失败怎么办、定位权限如何开启）。

**体验**
- 微信内地理定位、摄像头权限经常受限；需提供清晰引导与兜底（例如：无法定位→手动选择站点；无法扫码→司机端手输票据）。

**可靠性**
- 轮询策略在用户量上升后会增加服务器压力；需要按页面可见性/网络状态做退避。

**建议优先级**
- P0：展示“合同班次/工作日运行/下一班时间”、弱网提示、权限引导
- P1：到站/发车/延误通知（企业微信消息/群公告）
- P2：预约/拥挤度（若运营需要）

---

### 2.3 司机端（司机/核验员）

**完整性**
- 司机端最关键是“班次任务单 + 一键开始/结束 + 弱网核验兜底”。
- 目前核验流程偏 demo（提示/历史为模拟），生产需要真实记录与可追溯。

**实用性**
- 司机在行驶/停靠场景不适合复杂操作：需要更少按钮、更强反馈。

**可靠性**
- 微信上 `getUserMedia`/扫码能力不稳定，建议接入 **企业微信 JS-SDK 的 scanQRCode**（若可申请企业微信应用）。
- 核验必须幂等：同一票据重复扫、跨车次误扫、过期票据等。

**建议优先级**
- P0：核验记录真实落库 + 幂等 + 异常原因
- P1：班次状态流（到站/离站/结束）
- P2：司机签到/换班/车况

---

## 3. 生产环境关键要素评估

### 3.1 数据安全
- **最小化敏感信息展示**：司机手机号在乘客端避免全量展示（可脱敏）。
- **令牌/权限**：需要区分乘客/司机/管理，至少做到“入口隔离 + 角色校验”。
- **审计**：核验与配置变更必须可追溯。

> 微信内网页建议路径：
> - 乘客：允许匿名浏览（看线路/实时位置），需要生成乘车码时再做身份确认
> - 司机/管理：使用“专用链接 + 口令/企业微信身份”进入

### 3.2 系统性能
- 实时位置轮询建议：页面不可见时暂停；网络差时指数退避；多人同时访问时后端要限流。
- 静态资源缓存：对 hash 资源强缓存，HTML 短缓存。

### 3.3 可扩展性
- 预留多线路/多车辆：数据模型至少要支持 `lineId / vehicleId / driverId / tripId`。

### 3.4 用户反馈机制
- 需要“反馈入口 → 分类 → 处理状态 → 运营复盘”最小闭环。

---

## 4. 改进目标（分层）

### 最小生产可用（试运行）目标
- 乘客：能稳定查看线路与车辆位置、生成可核验乘车码、清楚下一班/运行时间。
- 司机：能快速核验、核验结果可追溯、弱网可用。
- 管理：能配置线路/班次/司机车辆信息、导出核验明细、有基本运营指标。

---

## 5. 分阶段改进计划（建议）

### 阶段 P0（1–2 周）：从 Demo 到“可试运行”

**交付清单**
1. **合同信息配置化（统一来源）**
   - 站点/班次/工作日运行/车辆/司机信息以配置为准，页面统一引用。
2. **班次展示与“下一班”逻辑**（乘客端 + 司机端）
   - 显示今日早/晚班次列表
   - 判断是否工作日，不是工作日给出“停运提示”
   - 根据当前时间计算“下一班发车时间”
3. **核验记录真实化**
   - 核验接口写入记录：时间、结果、票据ID、司机ID（或司机标识）、设备信息、站点（可选）
   - 幂等：同一票据重复核验返回一致结果
4. **权限/入口隔离（轻量）**
   - 司机端、管理端使用独立入口（URL 参数/路径）
   - 后端校验角色（至少防止乘客访问管理接口）
5. **弱网/权限提示与兜底**
   - 定位失败：提示开启权限/手动选择站点
   - 扫码失败：提供“手输票据”兜底（已具备雏形，需明确引导）

**验收标准**
- 工作日/非工作日提示准确
- 下一班显示准确（跨早晚高峰切换正确）
- 核验记录可导出/可查询，且重复核验不产生重复计数

---

### 阶段 P1（3–6 周）：运营化与可管理

**交付清单**
1. **管理端数据管理**
   - 站点/线路/班次/车辆/司机：可编辑、可导入导出
2. **事件与公告**
   - 延误/改线/临停/停运公告（管理端发布，乘客端展示）
3. **运营报表口径**
   - 今日核验人次（去重口径）、分站点核验、准点率（如有到站事件）
4. **用户反馈闭环**
   - 反馈表单（类型/描述/定位/图片可选）
   - 管理端工单列表与处理状态

**验收标准**
- 管理端能不改代码就调整班次/司机
- 反馈可追踪到处理结果

---

### 阶段 P2（6–12 周）：规模化与体验升级

**交付清单**
1. **企业微信身份对接（推荐）**
   - 通过企业微信 OAuth 获取用户身份，不依赖短信
   - 司机/管理与普通乘客权限隔离
2. **实时推送（可选）**
   - SSE/WebSocket 或更智能轮询（按需）
3. **多车辆/多线路**
   - 支持多个车牌与不同线路配置

---

## 6. 建议的新增功能需求清单（按角色）

### 管理端
- 线路/班次配置（工作日规则、节假日例外表）
- 核验明细查询与导出
- 公告/异常事件管理
- 权限角色（只读/运营/调度/管理员）

### 用户端
- 今日班次与下一班
- 停运提示（非工作日/临时停运）
- 站点导航（定位失败兜底：手动选站）
- 反馈入口

### 司机端
- 今日班次任务单
- 一键开始/结束班次
- 核验成功/失败强反馈 + 失败原因
- 弱网队列（可选）

---

## 7. 风险与建议

1. **微信内摄像头/扫码兼容性**：建议优先准备“手输票据”兜底，并在可行时对接企业微信 JS-SDK 的扫码能力。
2. **demo 数据与真实数据混用风险**：必须明确“配置来源”，不要页面写死、接口又读数据库导致不一致。
3. **统计口径**：上线前定义清楚“人次/人数/去重规则/跨天班次”，避免后续对账争议。

---

## 8. 下一步（需要你确认的 3 个问题）

1. 乘客端是否需要“免登录可看、登录才出码”？（推荐：免登录看信息，出码再校验）
2. 司机/管理端是否可以用“专用链接 + 口令”作为第一阶段身份方案？（企业微信对接放到 P2）
3. 是否需要“节假日/临时停运/临时加班车”配置？（合同外运营常见）
